USE [utilities]

SELECT
	SLA_weekdays.[DAY_OF_THE_WEEK]
	,SLA_weekdays.[DATE_ADJ] AS [DATE]
	,SLA_weekdays.[TYPE] AS [TYPE]
	,SUM(SLA_weekdays.[CALLS]) AS [CALLS]
	,AVG(SLA_weekdays.[SLA]) AS [SLA]
	,SUM(SLA_weekdays.[ABANDONED]) AS [# ABANDONED]
	,AVG(SLA_weekdays.[ABANDONED]) AS [% ABANDONED]
	,COUNT(DISTINCT SLA_weekdays.[AGENT NAME]) AS [# AGENTS]

FROM
(

	select distinct
		DATENAME(WEEKDAY, CASE WHEN[TIME] >= '21:00:00' THEN DATEADD(DAY,1,[DATE]) ELSE [DATE] END) AS [DAY_OF_THE_WEEK]
		,[DATE]
		,CASE
			WHEN[TIME] >= '21:00:00' THEN DATEADD(DAY,1,[DATE]) ELSE [DATE] END AS [DATE_ADJ]
		,[CALL ID]
		,[AGENT NAME]
		,calls.[CAMPAIGN]
		,tSLA.[TYPE]
		,min([TIME]) as [TIME]
		,min(DATEADD(hour,3,[TIME])) AS [TIME_ADJ]
	

		,CASE 
			WHEN [CALL ID] IS NOT NULL THEN 1 ELSE 0 END AS CALLS

		,CAST(
				CASE 
					WHEN DATEPART(minute,[IVR TIME]) <= 0
						AND DATEPART(second,[IVR TIME]) <= 20 
						AND ([ABANDONED] = 0 OR [ABANDONED] IS NULL)
						AND [AGENT NAME] IS NOT NULL THEN 1 ELSE 0 END AS DECIMAL(7,2)
				--CASE 
				--	WHEN DATEPART(minute,[IVR TIME]) <= 0 
				--		AND DATEPART(second,[IVR TIME]) > 20 THEN
				--			CASE
				--				WHEN ([ABANDONED] = 0 OR [ABANDONED] IS NULL) AND [AGENT NAME] IS NOT NULL THEN 1 ELSE 0 END
				--	WHEN DATEPART(minute,[IVR TIME]) <= 0
				--		AND DATEPART(second,[IVR TIME]) <= 20
				--		AND ([ABANDONED] = 0 OR [ABANDONED] IS NULL)
				--		AND [AGENT NAME] IS NOT NULL THEN 1 ELSE 0 END AS DECIMAL(7,2)
				) AS SLA

		,CAST(
				(CASE 
				WHEN [ABANDONED] IS NULL THEN 0
				ELSE [ABANDONED] END) AS decimal(7,2)) AS [ABANDONED]

		,count(distinct [AGENT]) AS AGENTS

	FROM [utilities].[dbo].[calls] as calls

	LEFT JOIN  [tSLA_CAMPAIGN_MAPPING_TABLE] tSLA
		on calls.[CAMPAIGN] = tSLA.[CAMPAIGN]

	WHERE [DATE] >= '2023-01-01'
		AND tSLA.[CAMPAIGN] IS NOT NULL
		and [CALL TYPE] = 'Inbound'

	GROUP BY
		DATENAME(WEEKDAY, CASE WHEN[TIME] >= '21:00:00' THEN DATEADD(DAY,1,[DATE]) ELSE [DATE] END)
		,[DATE]
		,CASE
			WHEN[TIME] >= '21:00:00' THEN DATEADD(DAY,1,[DATE]) ELSE [DATE] END
		,[CALL ID]
		,[AGENT NAME]
		,calls.[CAMPAIGN]
		,tSLA.[TYPE]

		,CASE 
			WHEN [CALL ID] IS NOT NULL THEN 1 ELSE 0 END

		,CAST(
				CASE 
					WHEN DATEPART(minute,[IVR TIME]) <= 0
						AND DATEPART(second,[IVR TIME]) <= 20 
						AND ([ABANDONED] = 0 OR [ABANDONED] IS NULL)
						AND [AGENT NAME] IS NOT NULL THEN 1 ELSE 0 END AS DECIMAL(7,2)
				--CASE 
				--	WHEN DATEPART(minute,[IVR TIME]) <= 0 
				--		AND DATEPART(second,[IVR TIME]) > 20 THEN
				--			CASE
				--				WHEN ([ABANDONED] = 0 OR [ABANDONED] IS NULL) AND [AGENT NAME] IS NOT NULL THEN 1 ELSE 0 END
				--	WHEN DATEPART(minute,[IVR TIME]) <= 0
				--		AND DATEPART(second,[IVR TIME]) <= 20
				--		AND ([ABANDONED] = 0 OR [ABANDONED] IS NULL)
				--		AND [AGENT NAME] IS NOT NULL THEN 1 ELSE 0 END AS DECIMAL(7,2)
			  ) 
		,CAST(
				(CASE 
				WHEN [ABANDONED] IS NULL THEN 0
				ELSE [ABANDONED] END) AS decimal(7,2))
) SLA_weekdays

WHERE (SLA_weekdays.[TIME_ADJ] >= '07:00:00' AND SLA_weekdays.[TIME_ADJ] < '21:00:00')
	AND SLA_weekdays.DAY_OF_THE_WEEK NOT IN ('Saturday','Sunday')

GROUP BY
	SLA_weekdays.[DAY_OF_THE_WEEK]
	,SLA_weekdays.[DATE_ADJ]
	,SLA_weekdays.[TYPE]


UNION ALL

SELECT
	SLA_weekends.[DAY_OF_THE_WEEK]
	,SLA_weekends.[DATE_ADJ] AS [DATE]
	,SLA_weekends.[TYPE] AS [TYPE]
	,SUM(SLA_weekends.[CALLS]) AS [CALLS]
	,AVG(SLA_weekends.[SLA]) AS [SLA]
	,SUM(SLA_weekends.[ABANDONED]) AS [# ABANDONED]
	,AVG(SLA_weekends.[ABANDONED]) AS [% ABANDONED]
	,COUNT(DISTINCT SLA_weekends.[AGENT NAME]) AS [# AGENTS]

FROM
(

	select distinct
		DATENAME(WEEKDAY, CASE WHEN[TIME] >= '21:00:00' THEN DATEADD(DAY,1,[DATE]) ELSE [DATE] END) AS [DAY_OF_THE_WEEK]
		,[DATE]
		,CASE
			WHEN[TIME] >= '21:00:00' THEN DATEADD(DAY,1,[DATE]) ELSE [DATE] END AS [DATE_ADJ]
		,[CALL ID]
		,[AGENT NAME]
		,calls.[CAMPAIGN]
		,tSLA.[TYPE]
		,min([TIME]) as [TIME]
		,min(DATEADD(hour,3,[TIME])) AS [TIME_ADJ]
	
		,CASE 
			WHEN [CALL ID] IS NOT NULL THEN 1 ELSE 0 END AS CALLS
		,CAST(
				CASE 
					WHEN DATEPART(minute,[IVR TIME]) <= 0
						AND DATEPART(second,[IVR TIME]) <= 20 
						AND ([ABANDONED] = 0 OR [ABANDONED] IS NULL)
						AND [AGENT NAME] IS NOT NULL THEN 1 ELSE 0 END AS DECIMAL(7,2)
				--CASE 
				--	WHEN DATEPART(minute,[IVR TIME]) <= 0 
				--		AND DATEPART(second,[IVR TIME]) > 20 THEN
				--			CASE
				--				WHEN ([ABANDONED] = 0 OR [ABANDONED] IS NULL) AND [AGENT NAME] IS NOT NULL THEN 1 ELSE 0 END
				--	WHEN DATEPART(minute,[IVR TIME]) <= 0
				--		AND DATEPART(second,[IVR TIME]) <= 20
				--		AND ([ABANDONED] = 0 OR [ABANDONED] IS NULL)
				--		AND [AGENT NAME] IS NOT NULL THEN 1 ELSE 0 END AS DECIMAL(7,2)
				) AS SLA
		,CAST(
				(CASE 
				WHEN [ABANDONED] IS NULL THEN 0
				ELSE [ABANDONED] END) AS decimal(7,2)) AS [ABANDONED]

		,count(distinct [AGENT]) AS AGENTS

	FROM [utilities].[dbo].[calls] as calls

	LEFT JOIN  [tSLA_CAMPAIGN_MAPPING_TABLE] tSLA
		on calls.[CAMPAIGN] = tSLA.[CAMPAIGN]

	WHERE [DATE] >= '2023-01-01'
		AND tSLA.[CAMPAIGN] IS NOT NULL
		and [CALL TYPE] = 'Inbound'

	GROUP BY
		DATENAME(WEEKDAY, CASE WHEN[TIME] >= '21:00:00' THEN DATEADD(DAY,1,[DATE]) ELSE [DATE] END)
		,[DATE]
		,CASE
			WHEN[TIME] >= '21:00:00' THEN DATEADD(DAY,1,[DATE]) ELSE [DATE] END
		,[CALL ID]
		,[AGENT NAME]
		,calls.[CAMPAIGN]
		,tSLA.[TYPE]

		,CASE 
			WHEN [CALL ID] IS NOT NULL THEN 1 ELSE 0 END

		,CAST(
				CASE 
					WHEN DATEPART(minute,[IVR TIME]) <= 0
						AND DATEPART(second,[IVR TIME]) <= 20 
						AND ([ABANDONED] = 0 OR [ABANDONED] IS NULL)
						AND [AGENT NAME] IS NOT NULL THEN 1 ELSE 0 END AS DECIMAL(7,2)
				--CASE 
				--	WHEN DATEPART(minute,[IVR TIME]) <= 0 
				--		AND DATEPART(second,[IVR TIME]) > 20 THEN
				--			CASE
				--				WHEN ([ABANDONED] = 0 OR [ABANDONED] IS NULL) AND [AGENT NAME] IS NOT NULL THEN 1 ELSE 0 END
				--	WHEN DATEPART(minute,[IVR TIME]) <= 0
				--		AND DATEPART(second,[IVR TIME]) <= 20
				--		AND ([ABANDONED] = 0 OR [ABANDONED] IS NULL)
				--		AND [AGENT NAME] IS NOT NULL THEN 1 ELSE 0 END AS DECIMAL(7,2)
			  ) 
		,CAST(
				(CASE 
				WHEN [ABANDONED] IS NULL THEN 0
				ELSE [ABANDONED] END) AS decimal(7,2))
) SLA_weekends

WHERE (SLA_weekends.[TIME_ADJ] >= '09:00:00' AND SLA_weekends.[TIME_ADJ] < '18:00:00')
	AND SLA_weekends.DAY_OF_THE_WEEK IN ('Saturday','Sunday')

GROUP BY
	SLA_weekends.[DAY_OF_THE_WEEK]
	,SLA_weekends.[DATE_ADJ]
	,SLA_weekends.[TYPE]



